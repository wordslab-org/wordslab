pwd
/Users/laurent

mkdir vm
cd vm

curl -O https://raw.githubusercontent.com/wordslab-org/wordslab/infrastructure-design/wordslab.installer/infrastructure/scripts/linux/metadata.yaml
curl -O https://raw.githubusercontent.com/wordslab-org/wordslab/infrastructure-design/wordslab.installer/infrastructure/scripts/linux/user-data.yaml
curl -O https://raw.githubusercontent.com/wordslab-org/wordslab/infrastructure-design/wordslab.installer/infrastructure/scripts/linux/wordslab-k3s-install.sh
curl -O https://raw.githubusercontent.com/wordslab-org/wordslab/infrastructure-design/wordslab.installer/infrastructure/scripts/linux/wordslab-k3s-start.sh
curl -O https://raw.githubusercontent.com/wordslab-org/wordslab/infrastructure-design/wordslab.installer/infrastructure/scripts/linux/wordslab-ubuntu-prepare.sh
curl -O https://raw.githubusercontent.com/wordslab-org/wordslab/infrastructure-design/wordslab.installer/infrastructure/scripts/linux/wordslab-vm-create.sh
curl -O https://raw.githubusercontent.com/wordslab-org/wordslab/infrastructure-design/wordslab.installer/infrastructure/scripts/linux/wordslab-vm-delete.sh
curl -O https://raw.githubusercontent.com/wordslab-org/wordslab/infrastructure-design/wordslab.installer/infrastructure/scripts/linux/wordslab-vm-k3s-install.sh
curl -O https://raw.githubusercontent.com/wordslab-org/wordslab/infrastructure-design/wordslab.installer/infrastructure/scripts/linux/wordslab-vm-k3s-start.sh
curl -O https://raw.githubusercontent.com/wordslab-org/wordslab/infrastructure-design/wordslab.installer/infrastructure/scripts/linux/wordslab-vm-start.sh

curl -O https://cloud-images.ubuntu.com/minimal/releases/focal/release-20220201/ubuntu-20.04-minimal-cloudimg-amd64.img
curl -O https://github.com/k3s-io/k3s/releases/download/v1.22.5%2Bk3s2/k3s
curl -O https://github.com/k3s-io/k3s/releases/download/v1.22.5%2Bk3s2/k3s-airgap-images-amd64.tar
curl -O https://get.helm.sh/helm-v3.7.2-linux-amd64.tar.gz

# ERROR : remove BOM from all downloaded files
# vi *.yaml *.sh
# :set nobomb
# :wq

qemu-system-x86_64 --version
QEMU emulator version 6.2.0
Copyright (c) 2003-2021 Fabrice Bellard and the QEMU Project developers

ls -al ~/.ssh
ls: /Users/laurent/.ssh: No such file or directory

ssh-keygen (3x Enter)
cat ~/.ssh/id_rsa.pub
vi user-data.yaml <- update ssh key

>> START trace of cloud-localds script execution on ubuntu
mktemp -d /tmp/cloud-localds.XXXXXX
TEMP_D=/tmp/cloud-localds.23Y0E5
cp metadata.yaml /tmp/cloud-localds.23Y0E5/meta-data
cp user-data.yaml /tmp/cloud-localds.23Y0E5/user-data
img=/tmp/cloud-localds.23Y0E5/seed-data
genisoimage -output /tmp/cloud-localds.23Y0E5/seed-data -volid cidata -joliet -rock /tmp/cloud-localds.23Y0E5/user-data /tmp/cloud-localds.23Y0E5/meta-data
cp /tmp/cloud-localds.23Y0E5/seed-data seed.img
debug 1 'wrote seed.img with filesystem=iso9660 and diskformat=raw'
rm -Rf /tmp/cloud-localds.23Y0E5
=> -rw-rw-r--  1 laurent laurent     374784 févr. 20 17:51 seed.img
>> END

>> START trace of cloud-init on Ubuntu
Reading from /var/lib/cloud/seed/nocloud/user-data
..
Reading from /var/lib/cloud/seed/nocloud-net/user-data
..
blkid -tTYPE=vfat -odevice => /dev/vda15
blkid -tTYPE=iso9660 -odevice => /dev/vdb 
blkid -tLABEL=CIDATA -odevice => ()
blkid -tLABEL=cidata -odevice => /dev/vdb
blkid tLABEL_FATBOOT=cidata -odevice => ()
Attempting to use data from /dev/vdb
Reading from /proc/mounts
mount -o ro -t auto /dev/vdb /run/cloud-init/tmp/tmpj658f3gz
Reading from /run/cloud-init/tmp/tmpj658f3gz//user-data
Reading from /run/cloud-init/tmp/tmpj658f3gz//meta-data
Reading from /run/cloud-init/tmp/tmpj658f3gz//vendor-data 
Reading from /run/cloud-init/tmp/tmpj658f3gz//network-config
umount /run/cloud-init/tmp/tmpj658f3gz
>> END

brew install cdrtools

mkdir tmp
cp meta-data tmp/meta-data
cp user-data tmp/user-data
mkisofs -output tmp/seed-data -volid cidata -joliet -rock tmp/meta-data tmp/user-data
cp tmp/seed-data seed.img
rm -Rf tmp

vi wordslab-vm-create.sh <- remove cloud-localds line <- specifify explcit backing file format
#!/bin/bash
mkisofs -output seed.img -volid cidata -joliet -rock meta-data user-data
qemu-img create -F qcow2 -b ubuntu-20.04-minimal-cloudimg-amd64.img -f qcow2 wordslab-os.img
qemu-img create -f qcow2 wordslab-cluster.img 10G
qemu-img create -f qcow2 wordslab-data.img 10G

chmod u+x *.sh
./wordslab-vm-delete.sh 
./wordslab-vm-delete.sh: line 1: ﻿#!/bin/bash: No such file or directory

vi wordslab-vm-start.sh <- accel=hvf <- $(nproc) ... $(sysctl -n hw.physicalcpu)
./wordslab-vm-start.sh
qemu-system-x86_64: Error: HV_ERROR

vi app.entitlements
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0"> <dict> <key>com.apple.security.hypervisor</key> <true/> </dict> </plist>

codesign -s - --entitlements app.entitlements --force /usr/local/bin/qemu-system-x86_64
/usr/local/bin/qemu-system-x86_64: replacing existing signature

./wordslab-vm-start.sh
qemu-system-x86_64: Error: HV_ERROR

sysctl -a | grep machdep.cpu.features
-> no VMX feature in Virtualbox

vi wordslab-vm-start.sh <- remove accel=hvf to test ...

./wordslab-vm-start.sh
qemu-system-x86_64: CPU model 'host' requires KVM or HVF

vi wordslab-vm-start.sh <- remove cpu line, using default qemu model
qemu-system-x86_64 \
  -machine type=q35 \
  -smp $(sysctl -n hw.physicalcpu) \
  -m 2G \
  -nographic \
  -device virtio-net-pci,netdev=net0 \
  -netdev user,id=net0,hostfwd=tcp::3022-:22,hostfwd=tcp::3080-:80,hostfwd=tcp::3443-:6443 \
  -drive if=virtio,format=qcow2,file=wordslab-os.img \
  -drive if=virtio,format=raw,file=seed.img \
  -drive if=virtio,format=qcow2,file=wordslab-cluster.img \
  -drive if=virtio,format=qcow2,file=wordslab-data.img

./wordslab-vm-start.sh
=> wait until vim-tiny install is finished
=> cloud-init[692]: Cloud-init v. 21.4-0ubuntu1~20.04.1 finished at Sat, 26 Feb

./wordslab-vm-k3s-install.sh
The authenticity of host '[0.0.0.0]:3022 ([0.0.0.0]:3022)' can't be established.
ECDSA key fingerprint is SHA256:pPV8k35WBiIYxO+D/TFeYK5/ekKBtdNfY6TFbsDcOQs.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
...

./wordslab-vm-k3s-start.sh
The connection to the server localhost:8080 was refused - did you specify the right host or port?

ssh -p 3022 ubuntu@0.0.0.0
k3s kubectl get ns
